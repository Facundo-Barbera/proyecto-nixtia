<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1.2</storyId>
    <title>Supabase Integration &amp; Database Setup</title>
    <status>drafted</status>
    <generatedAt>2025-11-21</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/stories/1-2-supabase-integration-database-setup.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>Supabase configured with initial database schema</iWant>
    <soThat>I can store products, orders, and user data securely</soThat>
    <tasks>
      - Task 1: Create Supabase project and configure credentials (AC: #1)
      - Task 2: Install Supabase client dependencies (AC: #2)
      - Task 3: Create Supabase client configuration files (AC: #2, #3)
      - Task 4: Install and configure Prisma ORM (AC: #4, #5, #6)
      - Task 5: Define database schema in Prisma (AC: #4, #5, #6)
      - Task 6: Run Prisma migrations and generate client (AC: #4, #5, #6)
      - Task 7: Configure Row-Level Security policies in Supabase (AC: #7)
      - Task 8: Create Prisma client singleton utility (AC: #3, #9)
      - Task 9: Seed database with test product data (AC: #8)
      - Task 10: Create test API route to verify database connection (AC: #3, #9)
      - Task 11: Testing and validation (AC: #3, #9)
    </tasks>
  </story>

  <acceptanceCriteria>
    1. Supabase Project Created: Supabase project created and credentials (URL, anon key, service role key) stored in .env.local and documented in .env.example
    2. Supabase Client Initialized: Supabase client initialized in Next.js app with browser and server client configurations
    3. Database Connection Verified: Database connection tested and verified working from Next.js application
    4. Products Table Created: products table created with columns: id, name, description, price, image_url, active, created_at, updated_at
    5. Orders Table Created: orders table created with columns: id, customer_phone, items_json, total, payment_method, status, created_at, updated_at
    6. Admin Users Table Created: admin_users table created with columns: id, email, created_at, updated_at
    7. RLS Policies Configured: Row-level security policies set up - Products (public read, admin write), Orders (admin only), Admin_users (admin only)
    8. Test Data Seeded: 5-10 artisan corn products seeded with realistic names, prices, and descriptions (masa, tortillas, blue corn products)
    9. Database Queries Verified: Test queries executed successfully to verify table structure and data access
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/solutioning/architecture.md</path>
        <title>Nixtia - Decision Architecture Document</title>
        <section>Supabase Backend Integration</section>
        <snippet>Supabase as backend-as-a-service (ADR-002) with PostgreSQL database, built-in authentication, Row-Level Security, and real-time capabilities. Connection pooling managed by Supabase (Supavisor).</snippet>
      </doc>
      <doc>
        <path>docs/solutioning/architecture.md</path>
        <title>Nixtia - Decision Architecture Document</title>
        <section>Prisma ORM Integration</section>
        <snippet>Prisma as ORM layer on top of Supabase PostgreSQL (ADR-005) for full TypeScript type safety, declarative migrations, and better query ergonomics. Client singleton pattern prevents multiple instances in development.</snippet>
      </doc>
      <doc>
        <path>docs/solutioning/architecture.md</path>
        <title>Nixtia - Decision Architecture Document</title>
        <section>Database Schema (Prisma)</section>
        <snippet>Complete Prisma schema with Product, Order, AdminUser models. UUID primary keys, Decimal(10,2) for monetary values, snake_case naming convention for tables/columns, created_at/updated_at timestamps on all models.</snippet>
      </doc>
      <doc>
        <path>docs/solutioning/architecture.md</path>
        <title>Nixtia - Decision Architecture Document</title>
        <section>Row-Level Security (Supabase)</section>
        <snippet>RLS enforced at database level for defense in depth. Public read access to active products, admin-only access to orders and admin_users. Service role key used server-side only, anon key safe for client (RLS restricts access).</snippet>
      </doc>
      <doc>
        <path>docs/planning/epics/epic-1-foundation-infrastructure.md</path>
        <title>Epic 1: Foundation &amp; Infrastructure</title>
        <section>Story 1.2: Supabase Integration &amp; Database Setup</section>
        <snippet>Configure Supabase with initial database schema for products (FR11-FR20), orders (FR40-FR43), and admin_users. RLS policies, test data seeding, and database query verification required.</snippet>
      </doc>
      <doc>
        <path>docs/planning/PRD/non-functional-requirements.md</path>
        <title>Non-Functional Requirements</title>
        <section>Security</section>
        <snippet>HTTPS enforcement, Row-Level Security for data protection, environment variables for sensitive data, SQL injection prevention via Prisma parameterized queries.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>src/lib/utils.ts</path>
        <kind>utility</kind>
        <symbol>cn</symbol>
        <lines>all</lines>
        <reason>Tailwind class merging utility - established pattern from Story 1.1, reuse for component styling</reason>
      </artifact>
      <artifact>
        <path>src/app/layout.tsx</path>
        <kind>layout</kind>
        <symbol>RootLayout</symbol>
        <lines>all</lines>
        <reason>Root layout component - may need updating if global database providers added in future stories</reason>
      </artifact>
      <artifact>
        <path>.env.example</path>
        <kind>config</kind>
        <symbol>n/a</symbol>
        <lines>all</lines>
        <reason>Environment variable template - MUST UPDATE with Supabase credentials and DATABASE_URL placeholders</reason>
      </artifact>
      <artifact>
        <path>package.json</path>
        <kind>config</kind>
        <symbol>n/a</symbol>
        <lines>all</lines>
        <reason>Dependency manifest - MUST UPDATE to add @supabase/supabase-js, @supabase/ssr, prisma, @prisma/client, tsx</reason>
      </artifact>
    </code>

    <dependencies>
      <ecosystem name="node">
        <existing>
          <package name="next" version="16.0.3" />
          <package name="react" version="19.2.0" />
          <package name="typescript" version="^5" />
          <package name="@radix-ui/react-slot" version="^1.2.4" />
          <package name="class-variance-authority" version="^0.7.1" />
          <package name="clsx" version="^2.1.1" />
          <package name="tailwind-merge" version="^3.4.0" />
          <package name="tailwindcss" version="^4" />
          <package name="eslint" version="^9" />
          <package name="prettier" version="^3.6.2" />
          <package name="@playwright/test" version="^1.49.1" />
        </existing>
        <toAdd>
          <package name="@supabase/supabase-js" version="latest" scope="dependencies" />
          <package name="@supabase/ssr" version="latest" scope="dependencies" />
          <package name="prisma" version="latest" scope="devDependencies" />
          <package name="@prisma/client" version="latest" scope="dependencies" />
          <package name="tsx" version="latest" scope="devDependencies" />
        </toAdd>
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    - Database Naming: MUST use snake_case for all table names (products, orders, admin_users) and column names (customer_phone, created_at, image_url) per Architecture standards
    - UUID Primary Keys: All models MUST use String @id @default(uuid()) for globally unique identifiers
    - Timestamps Required: All models MUST include created_at (DateTime @default(now())) and updated_at (DateTime @updatedAt) columns
    - Monetary Values: MUST use Decimal @db.Decimal(10, 2) for price/total fields to prevent floating-point precision issues
    - Project-Relative Imports: MUST use @/* import alias for all imports (e.g., @/lib/supabase/client, @/lib/prisma) as configured in tsconfig.json from Story 1.1
    - Environment Security: NEVER commit .env.local or real credentials to git. Service role key MUST only be used server-side, never exposed to client
    - RLS Enforcement: Row-Level Security MUST be enabled on all tables (products, orders, admin_users) for defense in depth
    - Prisma Singleton Pattern: MUST use global instance caching pattern for PrismaClient to prevent multiple connections in development
    - Migration Workflow: Database schema changes MUST go through Prisma migrations (npx prisma migrate dev) - never manual SQL DDL
    - Code Quality: Follow Prettier configuration from Story 1.1 (semicolons off, single quotes, 100-char width)
    - TypeScript Strict Mode: TypeScript strict mode is enabled - all code must be fully typed with no 'any' unless absolutely necessary
    - Testing Location: Integration tests for database should go in tests/integration/ directory (to be created in future stories)
  </constraints>

  <interfaces>
    <interface>
      <name>createBrowserClient</name>
      <kind>Function</kind>
      <signature>
        // src/lib/supabase/client.ts
        import { createBrowserClient } from '@supabase/ssr'

        export const createClient = () =&gt;
          createBrowserClient(
            process.env.NEXT_PUBLIC_SUPABASE_URL!,
            process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
          )
      </signature>
      <path>src/lib/supabase/client.ts (to be created)</path>
    </interface>
    <interface>
      <name>createServerClient</name>
      <kind>Function</kind>
      <signature>
        // src/lib/supabase/server.ts
        import { createServerClient } from '@supabase/ssr'
        import { cookies } from 'next/headers'

        export const createClient = () =&gt;
          createServerClient(
            process.env.NEXT_PUBLIC_SUPABASE_URL!,
            process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
            {
              cookies: {
                get(name: string) {
                  return cookies().get(name)?.value
                },
              },
            }
          )
      </signature>
      <path>src/lib/supabase/server.ts (to be created)</path>
    </interface>
    <interface>
      <name>prisma</name>
      <kind>PrismaClient Singleton</kind>
      <signature>
        // src/lib/prisma.ts
        import { PrismaClient } from '@prisma/client'

        const globalForPrisma = globalThis as unknown as {
          prisma: PrismaClient | undefined
        }

        export const prisma =
          globalForPrisma.prisma ??
          new PrismaClient({
            log: ['query', 'error', 'warn'],
          })

        if (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma
      </signature>
      <path>src/lib/prisma.ts (to be created)</path>
    </interface>
    <interface>
      <name>Product Prisma Model</name>
      <kind>Database Schema</kind>
      <signature>
        model Product {
          id          String   @id @default(uuid())
          name        String
          description String?
          price       Decimal  @db.Decimal(10, 2)
          image_url   String?
          active      Boolean  @default(true)
          created_at  DateTime @default(now())
          updated_at  DateTime @updatedAt

          @@map("products")
        }
      </signature>
      <path>prisma/schema.prisma (to be created)</path>
    </interface>
    <interface>
      <name>Order Prisma Model</name>
      <kind>Database Schema</kind>
      <signature>
        model Order {
          id             String   @id @default(uuid())
          customer_phone String
          items_json     Json
          total          Decimal  @db.Decimal(10, 2)
          payment_method String
          status         String   @default("pending")
          created_at     DateTime @default(now())
          updated_at     DateTime @updatedAt

          @@map("orders")
          @@index([customer_phone])
          @@index([created_at])
        }
      </signature>
      <path>prisma/schema.prisma (to be created)</path>
    </interface>
    <interface>
      <name>AdminUser Prisma Model</name>
      <kind>Database Schema</kind>
      <signature>
        model AdminUser {
          id         String   @id @default(uuid())
          email      String   @unique
          created_at DateTime @default(now())
          updated_at DateTime @updatedAt

          @@map("admin_users")
        }
      </signature>
      <path>prisma/schema.prisma (to be created)</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Testing framework: Playwright for E2E tests (installed in Story 1.1). Integration tests should use Vitest (to be installed in future stories). Database tests should verify: (1) Supabase connection, (2) Prisma client initialization, (3) RLS policies enforced, (4) CRUD operations on all tables, (5) seed data integrity. Test naming: *.test.ts for unit/integration, *.spec.ts for E2E. Location: tests/integration/ for database integration tests, tests/e2e/ for end-to-end.
    </standards>

    <locations>
      - tests/integration/database/ (to be created)
      - src/app/api/test-db/route.ts (manual test endpoint)
      - prisma/seed.ts (seed script doubles as data integrity test)
    </locations>

    <ideas>
      - AC1: Test that .env.local contains all required Supabase credentials (NEXT_PUBLIC_SUPABASE_URL, NEXT_PUBLIC_SUPABASE_ANON_KEY, SUPABASE_SERVICE_ROLE_KEY, DATABASE_URL)
      - AC2: Test Supabase browser client initializes without errors and connects to project
      - AC2: Test Supabase server client initializes with cookies integration
      - AC3: Integration test: Verify database connection by querying Supabase health endpoint
      - AC4: Test products table exists with correct schema (9 columns: id, name, description, price, image_url, active, created_at, updated_at)
      - AC5: Test orders table exists with correct schema and indexes on customer_phone and created_at
      - AC6: Test admin_users table exists with email unique constraint
      - AC7: Test RLS policy: Anonymous user can SELECT from products where active=true
      - AC7: Test RLS policy: Anonymous user cannot INSERT/UPDATE/DELETE products
      - AC7: Test RLS policy: Service role can perform all operations (verified via Prisma queries)
      - AC8: Test seed script creates 5-10 products with valid data (price &gt; 0, name not empty)
      - AC8: Verify seeded product names include artisan corn products (masa, tortillas, etc.)
      - AC9: Test Prisma query: await prisma.product.findMany() returns seeded products
      - AC9: Test Prisma query: await prisma.product.create() successfully inserts new product
      - Manual: Access /api/test-db endpoint and verify JSON response with product data
      - Manual: Open Prisma Studio (npx prisma studio) and browse products, orders, admin_users tables
      - Manual: Check Supabase dashboard Table Editor shows all 3 tables with correct structure
    </ideas>
  </tests>
</story-context>

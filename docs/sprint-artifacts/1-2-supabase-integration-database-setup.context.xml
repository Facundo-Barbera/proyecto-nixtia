<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>2</storyId>
    <title>Supabase Integration &amp; Database Setup</title>
    <status>drafted</status>
    <generatedAt>2025-11-24</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-2-supabase-integration-database-setup.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>Supabase configured with initial database schema</iWant>
    <soThat>I can store products, orders, and user data securely</soThat>
    <tasks>
      <task id="1" ac="1">Create Supabase project and configure environment</task>
      <task id="2" ac="2">Install Supabase and Prisma dependencies</task>
      <task id="3" ac="4,5,6">Initialize Prisma and define schema</task>
      <task id="4" ac="3,4,5,6">Create initial database migration</task>
      <task id="5" ac="7,8,9,10">Configure Row-Level Security policies</task>
      <task id="6" ac="2">Create Supabase client utilities</task>
      <task id="7" ac="12">Create Prisma Client singleton</task>
      <task id="8" ac="11">Create seed script with artisan corn product data</task>
      <task id="9" ac="3,12">Verify database connection and queries</task>
      <task id="10">Testing and validation</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">Supabase Project: Supabase project created and credentials stored in environment variables</criterion>
    <criterion id="2">Supabase Client: Supabase client initialized in Next.js app</criterion>
    <criterion id="3">Database Connection: Database connection verified</criterion>
    <criterion id="4">Products Table: `products` table exists with schema (id, name, description, price, image_url, active, created_at)</criterion>
    <criterion id="5">Orders Table: `orders` table exists with schema (id, customer_phone, items_json, total, payment_method, status, created_at)</criterion>
    <criterion id="6">Admin Users Table: `admin_users` table exists with schema (id, email, created_at)</criterion>
    <criterion id="7">RLS Products Read: Row-level security policy allows public read access to products</criterion>
    <criterion id="8">RLS Products Write: Row-level security policy restricts write access to products (admin-only)</criterion>
    <criterion id="9">RLS Orders: Row-level security policy restricts all access to orders (admin-only)</criterion>
    <criterion id="10">RLS Admin Users: Row-level security policy restricts all access to admin_users (admin-only)</criterion>
    <criterion id="11">Test Data: Test data seeded (5-10 products with names, prices, descriptions)</criterion>
    <criterion id="12">Query Execution: Database queries execute successfully (verified via Prisma Client test query)</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/planning/epics/epic-1-foundation-infrastructure.md</path>
        <title>Epic 1: Foundation &amp; Infrastructure</title>
        <section>Story 1.2: Supabase Integration &amp; Database Setup</section>
        <snippet>Establishes Supabase project with PostgreSQL database, Prisma ORM integration, initial schema (products, orders, admin_users tables), and RLS policies. Prerequisites: Story 1.1 completed.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/archive/tech-spec-epic-1.md</path>
        <title>Epic Technical Specification: Foundation &amp; Infrastructure</title>
        <section>Prisma Schema (lines 112-193)</section>
        <snippet>Complete database schema with Product, Order, OrderItem, AdminUser models. Includes PaymentMethod, PaymentStatus, OrderStatus enums. Defines indexes on customer_phone and created_at.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/archive/tech-spec-epic-1.md</path>
        <title>Epic Technical Specification: Foundation &amp; Infrastructure</title>
        <section>Environment Variables Interface (lines 213-221)</section>
        <snippet>Defines required environment variables: DATABASE_URL, NEXT_PUBLIC_SUPABASE_URL, NEXT_PUBLIC_SUPABASE_ANON_KEY, SUPABASE_SERVICE_ROLE_KEY, Stripe keys.</snippet>
      </doc>
      <doc>
        <path>docs/solutioning/architecture.md</path>
        <title>Nixtia - Decision Architecture Document</title>
        <section>Supabase Client Integration (lines 246-272)</section>
        <snippet>Defines createClient patterns for browser and server contexts using @supabase/ssr. Browser client uses createBrowserClient, server client uses createServerClient with cookies integration.</snippet>
      </doc>
      <doc>
        <path>docs/solutioning/architecture.md</path>
        <title>Nixtia - Decision Architecture Document</title>
        <section>Prisma ORM Integration (lines 290-307)</section>
        <snippet>Prisma singleton pattern to prevent multiple client instances. Configured with query logging (query, error, warn). Global reference for development mode.</snippet>
      </doc>
      <doc>
        <path>docs/solutioning/architecture.md</path>
        <title>Nixtia - Decision Architecture Document</title>
        <section>Database Schema Prisma (ADR-005)</section>
        <snippet>Rationale for Prisma ORM: Full TypeScript type safety, declarative migrations, better query ergonomics. Command sequence: init, migrate dev, generate, studio.</snippet>
      </doc>
      <doc>
        <path>docs/planning/PRD/non-functional-requirements.md</path>
        <title>Non-Functional Requirements</title>
        <section>Security Baseline</section>
        <snippet>HTTPS enforced, environment variables for secrets, Row-Level Security enabled on all database tables.</snippet>
      </doc>
      <doc>
        <path>docs/brownfield/data-models.md</path>
        <title>Data Models Documentation</title>
        <section>Database Schema</section>
        <snippet>PostgreSQL schema via Prisma: products (id, name, description, price, image_url, active), orders (id, order_number, customer_phone, items_json, total, payment_method, payment_status, order_status), admin_users (id, email).</snippet>
      </doc>
      <doc>
        <path>docs/brownfield/development-guide.md</path>
        <title>Development Guide</title>
        <section>Database Management</section>
        <snippet>Prisma commands: npx prisma studio (visual editor), npx prisma generate (regenerate client), npx prisma migrate dev (create migration), npx prisma db seed (run seed script).</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>src/lib/prisma.ts</path>
        <kind>service</kind>
        <symbol>prisma</symbol>
        <lines>1-14</lines>
        <reason>EXISTING Prisma Client singleton - already implemented per Architecture pattern. Use this for all database operations in this story.</reason>
      </artifact>
      <artifact>
        <path>src/lib/supabase/client.ts</path>
        <kind>service</kind>
        <symbol>createClient</symbol>
        <lines>1-9</lines>
        <reason>EXISTING browser Supabase client - already implemented using @supabase/ssr createBrowserClient pattern.</reason>
      </artifact>
      <artifact>
        <path>src/lib/supabase/server.ts</path>
        <kind>service</kind>
        <symbol>createClient</symbol>
        <lines>1-30</lines>
        <reason>EXISTING server Supabase client - already implemented with Next.js 16 cookies() pattern using async/await.</reason>
      </artifact>
      <artifact>
        <path>src/lib/utils.ts</path>
        <kind>utility</kind>
        <symbol>cn</symbol>
        <lines>1-7</lines>
        <reason>Tailwind class merging utility from Story 1.1 - available for reuse in components.</reason>
      </artifact>
      <artifact>
        <path>prisma/schema.prisma</path>
        <kind>schema</kind>
        <symbol>schema</symbol>
        <lines>1-65</lines>
        <reason>EXISTING database schema - already defined with products, orders, admin_users tables and enums. May need updates to match Tech Spec requirements.</reason>
      </artifact>
      <artifact>
        <path>prisma/rls-policies.sql</path>
        <kind>sql</kind>
        <symbol>RLS policies</symbol>
        <lines>1-38</lines>
        <reason>EXISTING RLS policies SQL script - defines public read access to active products and service role policies for admin operations.</reason>
      </artifact>
      <artifact>
        <path>prisma/seed.ts</path>
        <kind>script</kind>
        <symbol>seed</symbol>
        <lines>all</lines>
        <reason>EXISTING seed script - should populate test data with artisan corn products per acceptance criteria.</reason>
      </artifact>
      <artifact>
        <path>.env.example</path>
        <kind>config</kind>
        <symbol>environment template</symbol>
        <lines>1-17</lines>
        <reason>EXISTING environment variables template - includes Supabase and Stripe configuration placeholders from Story 1.1.</reason>
      </artifact>
      <artifact>
        <path>package.json</path>
        <kind>config</kind>
        <symbol>dependencies</symbol>
        <lines>23-43</lines>
        <reason>Project dependencies including @prisma/client 6.19.0, @supabase/ssr 0.7.0, @supabase/supabase-js 2.84.0.</reason>
      </artifact>
    </code>
    <dependencies>
      <ecosystem name="npm">
        <package name="@prisma/client" version="^6.19.0" />
        <package name="prisma" version="^6.19.0" />
        <package name="@supabase/ssr" version="^0.7.0" />
        <package name="@supabase/supabase-js" version="^2.84.0" />
        <package name="zod" version="^4.1.13" />
        <package name="react-hook-form" version="^7.66.1" />
        <package name="date-fns" version="^4.1.0" />
        <package name="next" version="16.0.3" />
        <package name="react" version="19.2.0" />
        <package name="typescript" version="^5" />
      </ecosystem>
      <ecosystem name="database">
        <package name="PostgreSQL" version="via Supabase Cloud" />
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architectural">Must use Prisma ORM for all database access (ADR-005) - provides full TypeScript type safety and declarative migrations</constraint>
    <constraint type="security">Row-Level Security (RLS) must be enabled on ALL tables - products, orders, admin_users (NFR requirement)</constraint>
    <constraint type="connection">Must use Supabase Transaction mode (port 6543) for DATABASE_URL connection string - enables connection pooling for serverless</constraint>
    <constraint type="build">Must run "prisma generate" before Next.js build - add to package.json build script if not present</constraint>
    <constraint type="schema">Database schema must match Tech Spec Epic 1 (lines 112-193) - authoritative source for table definitions</constraint>
    <constraint type="data-format">customer_phone must use E.164 format (+1234567890) - international phone number standard</constraint>
    <constraint type="naming">Database tables use snake_case (products, order_items, admin_users), columns also snake_case (customer_phone, created_at)</constraint>
    <constraint type="typescript">TypeScript strict mode enabled - proper null/undefined handling required in all Prisma queries</constraint>
    <constraint type="architecture">Use Next.js 16 App Router Server Components for database queries where possible (default rendering)</constraint>
    <constraint type="environment">Environment variables for secrets - NEVER expose SUPABASE_SERVICE_ROLE_KEY to client</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>Supabase Browser Client</name>
      <kind>service factory</kind>
      <signature>createClient(): SupabaseClient</signature>
      <path>src/lib/supabase/client.ts</path>
      <description>Browser-side Supabase client using createBrowserClient from @supabase/ssr</description>
    </interface>
    <interface>
      <name>Supabase Server Client</name>
      <kind>service factory</kind>
      <signature>async createClient(): Promise&lt;SupabaseClient&gt;</signature>
      <path>src/lib/supabase/server.ts</path>
      <description>Server-side Supabase client with Next.js 16 async cookies integration</description>
    </interface>
    <interface>
      <name>Prisma Client</name>
      <kind>database client</kind>
      <signature>prisma: PrismaClient</signature>
      <path>src/lib/prisma.ts</path>
      <description>Singleton Prisma client with query logging - use for all database operations</description>
    </interface>
    <interface>
      <name>Database Connection</name>
      <kind>environment variable</kind>
      <signature>DATABASE_URL=postgresql://user:password@host:6543/database</signature>
      <path>.env.local</path>
      <description>Supabase PostgreSQL connection string in Transaction mode (port 6543)</description>
    </interface>
    <interface>
      <name>Product Model</name>
      <kind>prisma model</kind>
      <signature>{ id: string, name: string, description?: string, price: Decimal, image_url?: string, active: boolean, created_at: DateTime, updated_at: DateTime }</signature>
      <path>@prisma/client</path>
      <description>Generated TypeScript type from Prisma schema - use for type-safe product operations</description>
    </interface>
  </interfaces>

  <tests>
    <standards>Testing uses Vitest for unit tests and Playwright for E2E tests. Vitest configured with jsdom environment and @/ import alias. Unit tests focus on utilities and hooks. E2E tests verify critical user flows (checkout, admin dashboard). Database operations should be tested via integration tests using test database or mocked Prisma client. RLS policies tested manually via Supabase SQL Editor or E2E tests with different auth contexts.</standards>
    <locations>
      <location>tests/unit/</location>
      <location>tests/e2e/</location>
      <location>tests/support/fixtures/</location>
      <location>tests/support/helpers/</location>
    </locations>
    <ideas>
      <idea ac="1,2,3">Test Supabase connection: Create test API route or script that verifies DATABASE_URL connection and Supabase client initialization</idea>
      <idea ac="4,5,6">Test Prisma schema: Run "npx prisma validate" and verify all tables exist via "npx prisma studio" or SQL query</idea>
      <idea ac="7,8,9,10">Test RLS policies: Use Supabase SQL Editor to test public SELECT on active products, verify INSERT/UPDATE blocked for anonymous users, verify admin operations work with service role</idea>
      <idea ac="11">Test seed data: Run "npx prisma db seed" and verify 5-10 products inserted with artisan corn product names and prices</idea>
      <idea ac="12">Test query execution: Create simple test query using prisma.products.findMany() to verify Prisma Client works and returns seeded data</idea>
      <idea ac="3">Integration test: Verify database connection from Next.js app by creating /api/test-db route that queries database and returns status</idea>
    </ideas>
  </tests>
</story-context>

<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>6</storyId>
    <title>Build Verification and Clean State</title>
    <status>drafted</status>
    <generatedAt>2025-11-25</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-6-build-verification-and-clean-state.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>verify the app builds and runs without Prisma</iWant>
    <soThat>the migration is complete and verified, unblocking all subsequent epics</soThat>
    <tasks>
      <task id="1" title="Build Pipeline Verification" ac="6.1, 6.2">
        <subtask>Run `npm run build` and capture output</subtask>
        <subtask>Verify build completes with exit code 0</subtask>
        <subtask>Check `.next/` directory contains build artifacts</subtask>
        <subtask>Run `npm run lint` and capture output</subtask>
        <subtask>Verify lint passes (warnings OK, errors block)</subtask>
      </task>
      <task id="2" title="Development Server Verification" ac="6.3">
        <subtask>Run `npm run dev`</subtask>
        <subtask>Verify server starts without errors</subtask>
        <subtask>Check console for any Prisma-related warnings</subtask>
      </task>
      <task id="3" title="Store Page Smoke Test" ac="6.4">
        <subtask>Navigate to `/store` in browser</subtask>
        <subtask>Verify products display correctly</subtask>
        <subtask>Check browser DevTools console for errors</subtask>
        <subtask>Check Network tab shows Supabase requests (not Prisma)</subtask>
      </task>
      <task id="4" title="Admin Dashboard Smoke Test" ac="6.5">
        <subtask>Navigate to `/admin/login`</subtask>
        <subtask>Enter valid admin credentials</subtask>
        <subtask>Verify redirect to `/admin/dashboard`</subtask>
        <subtask>Verify transactions table displays data</subtask>
        <subtask>Check console for any errors</subtask>
      </task>
      <task id="5" title="Checkout Flow E2E Verification" ac="6.3, 6.4">
        <subtask>Add product to cart from store page</subtask>
        <subtask>Navigate to checkout</subtask>
        <subtask>Enter phone number and select payment method</subtask>
        <subtask>Submit order</subtask>
        <subtask>Verify success page shows order details</subtask>
        <subtask>Verify order in Supabase dashboard (manual check)</subtask>
      </task>
      <task id="6" title="Codebase Clean State Verification" ac="6.6, 6.7">
        <subtask>Run `grep -r "prisma" src/` - expect no code results</subtask>
        <subtask>Run `grep -r "@prisma" package.json` - expect no results</subtask>
        <subtask>Run `grep -r "from '@/lib/prisma'" src/` - expect no results</subtask>
        <subtask>Verify `prisma/` directory does not exist</subtask>
        <subtask>Verify `node_modules/.prisma/` does not exist</subtask>
      </task>
      <task id="7" title="Document Results" ac="All">
        <subtask>Record all verification results in Completion Notes</subtask>
        <subtask>Note any warnings or minor issues observed</subtask>
        <subtask>Confirm Epic 1 completion gate passed</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-6.1" title="Build completes successfully">
      <description>`npm run build` completes successfully with no errors</description>
      <checks>
        <check>No TypeScript errors</check>
        <check>No missing module errors</check>
        <check>Build output generated in `.next/` directory</check>
      </checks>
    </criterion>
    <criterion id="AC-6.2" title="Lint passes">
      <description>`npm run lint` passes (warnings acceptable)</description>
      <checks>
        <check>ESLint rules pass</check>
        <check>No blocking lint errors</check>
      </checks>
    </criterion>
    <criterion id="AC-6.3" title="Dev server starts">
      <description>`npm run dev` starts without errors</description>
      <checks>
        <check>Development server launches successfully</check>
        <check>No runtime errors in console</check>
      </checks>
    </criterion>
    <criterion id="AC-6.4" title="Store page loads products">
      <description>Store page loads and displays products</description>
      <checks>
        <check>Navigate to `/store`</check>
        <check>Products display from Supabase</check>
        <check>No Prisma-related errors in console</check>
      </checks>
    </criterion>
    <criterion id="AC-6.5" title="Admin dashboard works">
      <description>Admin login works and dashboard loads transactions</description>
      <checks>
        <check>Navigate to `/admin/login`</check>
        <check>Login as admin successfully</check>
        <check>Dashboard at `/admin/dashboard` shows transactions</check>
      </checks>
    </criterion>
    <criterion id="AC-6.6" title="No Prisma code references">
      <description>`grep -r "prisma" src/` returns no results</description>
      <checks>
        <check>No code references to Prisma in src/ directory</check>
        <check>Only comments or documentation references acceptable</check>
      </checks>
    </criterion>
    <criterion id="AC-6.7" title="No Prisma packages">
      <description>`grep -r "@prisma" package.json` returns no results</description>
      <checks>
        <check>No `@prisma/client` in dependencies</check>
        <check>No `prisma` package in dependencies</check>
      </checks>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Epic 1 Technical Specification</title>
        <section>AC-6: Build Verification (Story 1.6)</section>
        <snippet>Comprehensive technical spec for database migration. Contains all acceptance criteria, verification commands, and expected results for build verification.</snippet>
      </doc>
      <doc>
        <path>docs/planning/architecture/critical-architecture-decision-supabase-only-data-layer.md</path>
        <title>ADR-001: Supabase-Only Data Layer</title>
        <section>Migration Required</section>
        <snippet>Critical decision to remove Prisma entirely and use Supabase client exclusively. Rationale: Native RLS security, no schema drift, simpler architecture.</snippet>
      </doc>
      <doc>
        <path>docs/planning/epics/epic-1-database-migration-prisma-supabase.md</path>
        <title>Epic 1: Database Migration</title>
        <section>Story 1.6: Build Verification and Clean State</section>
        <snippet>Epic definition containing story requirements. This story is the gate for Epic 1 completion - all subsequent epics depend on this passing.</snippet>
      </doc>
      <doc>
        <path>docs/planning/architecture/index.md</path>
        <title>Architecture Index</title>
        <section>Table of Contents</section>
        <snippet>Index of all architecture documents including ADRs, data architecture, security, and implementation patterns.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/1-5-verify-orders-api-route-uses-supabase.md</path>
        <title>Story 1.5: Verify Orders API</title>
        <section>Dev Agent Record</section>
        <snippet>Previous story completion with learnings: Migration pattern validated, E2E flow complete, orphaned files removed. All query patterns established.</snippet>
      </doc>
    </docs>
    <code>
      <file>
        <path>src/lib/supabase/server.ts</path>
        <kind>service</kind>
        <symbol>createClient</symbol>
        <lines>1-29</lines>
        <reason>Server-side Supabase client. Uses NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY (NOT legacy ANON_KEY). Verify this exists and functions correctly.</reason>
      </file>
      <file>
        <path>src/lib/supabase/client.ts</path>
        <kind>service</kind>
        <symbol>createClient</symbol>
        <reason>Browser-side Supabase client. Uses NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY (NOT legacy ANON_KEY). Should exist for client components.</reason>
      </file>
      <file>
        <path>src/app/store/page.tsx</path>
        <kind>page</kind>
        <symbol>StorePage</symbol>
        <lines>1-61</lines>
        <reason>Migrated in Story 1.2. Uses Supabase to fetch products with proper error handling. Verify loads correctly.</reason>
      </file>
      <file>
        <path>src/app/landing/page.tsx</path>
        <kind>page</kind>
        <symbol>LandingPage</symbol>
        <lines>1-48</lines>
        <reason>Migrated in Story 1.3. Uses Supabase with .limit(6) for featured products. Verify renders correctly.</reason>
      </file>
      <file>
        <path>src/app/admin/dashboard/page.tsx</path>
        <kind>page</kind>
        <symbol>AdminDashboardPage</symbol>
        <lines>1-82</lines>
        <reason>Migrated in Story 1.4. Uses Supabase to fetch orders. Verify auth and data loading work.</reason>
      </file>
      <file>
        <path>src/app/api/orders/route.ts</path>
        <kind>api-route</kind>
        <symbol>POST, GET</symbol>
        <lines>1-168</lines>
        <reason>Migrated in Story 1.5. Creates orders via Supabase. Verify checkout flow completes.</reason>
      </file>
      <file>
        <path>package.json</path>
        <kind>config</kind>
        <symbol>scripts, dependencies</symbol>
        <lines>1-61</lines>
        <reason>Build script should be "next build" (no prisma generate). No @prisma/client or prisma packages.</reason>
      </file>
    </code>
    <dependencies>
      <node>
        <runtime>
          <package name="next" version="16.0.3">React framework</package>
          <package name="react" version="19.2.0">UI library</package>
          <package name="react-dom" version="19.2.0">React DOM rendering</package>
          <package name="@supabase/supabase-js" version="^2.84.0">Supabase JavaScript client</package>
          <package name="@supabase/ssr" version="^0.7.0">Supabase SSR support with cookies</package>
          <package name="zod" version="^4.1.13">Schema validation</package>
          <package name="react-hook-form" version="^7.66.1">Form handling</package>
          <package name="lucide-react" version="^0.554.0">Icons</package>
          <package name="tailwind-merge" version="^3.4.0">Tailwind utilities</package>
        </runtime>
        <dev>
          <package name="typescript" version="^5">TypeScript compiler</package>
          <package name="eslint" version="^9">Linting</package>
          <package name="prettier" version="^3.6.2">Code formatting</package>
          <package name="vitest" version="^4.0.13">Unit testing</package>
          <package name="@playwright/test" version="^1.49.1">E2E testing</package>
          <package name="supabase" version="^2.61.2">Supabase CLI for type generation</package>
          <package name="tailwindcss" version="^4">CSS framework</package>
        </dev>
        <removed>
          <package name="@prisma/client">REMOVED - was database ORM</package>
          <package name="prisma">REMOVED - was schema management</package>
        </removed>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architectural">
      <rule>All database queries MUST use createClient() from @/lib/supabase/server (server components) or @/lib/supabase/client (client components)</rule>
      <source>ADR-001</source>
    </constraint>
    <constraint type="architectural">
      <rule>Queries MUST respect RLS policies (automatic with Supabase client)</rule>
      <source>ADR-001</source>
    </constraint>
    <constraint type="error-handling">
      <rule>All Supabase queries MUST handle { data, error } response pattern with graceful degradation</rule>
      <source>Tech Spec - Reliability</source>
    </constraint>
    <constraint type="caching">
      <rule>ISR caching settings MUST be preserved: revalidate=300 for store, revalidate=60 for admin</rule>
      <source>Tech Spec - Performance</source>
    </constraint>
    <constraint type="security">
      <rule>No secrets exposed: Supabase publishable key is public, secret key stays server-side only</rule>
      <source>Security Architecture</source>
    </constraint>
    <constraint type="environment" critical="true">
      <rule>MUST use NEW Supabase key format (June 2025+). Legacy anon/service_role keys are DEPRECATED.</rule>
      <source>ADR - Supabase Key Migration</source>
      <details>
        Required env vars:
        - NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY (replaces NEXT_PUBLIC_SUPABASE_ANON_KEY)
        - SUPABASE_SECRET_KEY (replaces SUPABASE_SERVICE_ROLE_KEY)
        - NEXT_PUBLIC_SUPABASE_URL (unchanged)
        DO NOT use: NEXT_PUBLIC_SUPABASE_ANON_KEY, SUPABASE_SERVICE_ROLE_KEY
      </details>
    </constraint>
    <constraint type="clean-state">
      <rule>No Prisma code references in src/ (comments about migration acceptable)</rule>
      <source>Story 1.6 AC-6.6</source>
    </constraint>
    <constraint type="clean-state">
      <rule>No @prisma/client or prisma packages in package.json</rule>
      <source>Story 1.6 AC-6.7</source>
    </constraint>
    <constraint type="clean-state">
      <rule>Build script must be "next build" without prisma generate</rule>
      <source>Tech Spec - Dependencies</source>
    </constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>createClient (Server)</name>
      <kind>function</kind>
      <signature>async function createClient(): Promise&lt;SupabaseClient&gt;</signature>
      <path>src/lib/supabase/server.ts</path>
      <usage>Used in server components to create authenticated Supabase client with cookie-based auth</usage>
    </interface>
    <interface>
      <name>Supabase Query Pattern</name>
      <kind>query-pattern</kind>
      <signature>const { data, error } = await supabase.from('table').select('*').eq('column', value)</signature>
      <path>All migrated pages</path>
      <usage>Standard pattern for all database queries. Always check error before using data.</usage>
    </interface>
    <interface>
      <name>Products Query</name>
      <kind>database-query</kind>
      <signature>supabase.from('products').select('id, name, description, price, image_url').eq('is_active', true)</signature>
      <path>src/app/store/page.tsx, src/app/landing/page.tsx</path>
      <usage>Fetches active products. Note: column is 'is_active' not 'active'</usage>
    </interface>
    <interface>
      <name>Orders Query</name>
      <kind>database-query</kind>
      <signature>supabase.from('orders').select('*').order('created_at', { ascending: false }).limit(100)</signature>
      <path>src/app/admin/dashboard/page.tsx</path>
      <usage>Fetches orders for admin dashboard, sorted by newest first</usage>
    </interface>
    <interface>
      <name>POST /api/orders</name>
      <kind>REST endpoint</kind>
      <signature>POST /api/orders { customerPhone, paymentMethod, items[] } => { success, order }</signature>
      <path>src/app/api/orders/route.ts</path>
      <usage>Creates new order. Returns order with generated ID and order_number.</usage>
    </interface>
  </interfaces>

  <tests>
    <standards>Per project standards, no automated test suite exists for this verification story. Verification is manual:
1. Build verification: CLI commands with exit codes (npm run build, npm run lint)
2. Runtime verification: Manual browser testing (dev server, page loads, checkout flow)
3. Clean state verification: grep commands to confirm no Prisma references
Test frameworks available: Vitest for unit tests, Playwright for E2E tests, but not required for this story.</standards>
    <locations>
      <location>CLI commands for build/lint verification</location>
      <location>Browser DevTools for runtime verification</location>
      <location>Supabase Dashboard for data verification</location>
      <location>grep commands for codebase clean state</location>
    </locations>
    <ideas>
      <idea ac="AC-6.1">Run `npm run build` and verify exit code 0, check .next/ directory exists with build artifacts</idea>
      <idea ac="AC-6.2">Run `npm run lint` and verify no blocking errors (warnings OK)</idea>
      <idea ac="AC-6.3">Run `npm run dev` and verify server starts on localhost:3000 without errors</idea>
      <idea ac="AC-6.4">Navigate to /store, verify products display, check Network tab for Supabase requests</idea>
      <idea ac="AC-6.5">Navigate to /admin/login, login with valid credentials, verify dashboard shows transactions</idea>
      <idea ac="AC-6.6">Run `grep -r "prisma" src/` - expect only comments about migration, no code references</idea>
      <idea ac="AC-6.7">Run `grep -r "@prisma" package.json` - expect no results</idea>
      <idea ac="All">Complete checkout flow: add to cart -> checkout -> submit -> verify success page and Supabase dashboard</idea>
    </ideas>
  </tests>
</story-context>

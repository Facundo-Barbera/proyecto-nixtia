<story-context id="1-4-migrate-admin-dashboard-to-supabase" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>4</storyId>
    <title>Migrate Admin Dashboard to Supabase</title>
    <status>drafted</status>
    <generatedAt>2025-11-25</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-4-migrate-admin-dashboard-to-supabase.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>admin</asA>
    <iWant>view transactions fetched from Supabase</iWant>
    <soThat>the dashboard works without Prisma and benefits from proper RLS security</soThat>
    <tasks>
      <task id="1" ac="4.1">
        <title>Update imports</title>
        <subtasks>
          <subtask>Remove `import { prisma } from '@/lib/prisma'`</subtask>
          <subtask>Add `import { createClient } from '@/lib/supabase/server'`</subtask>
        </subtasks>
      </task>
      <task id="2" ac="4.2">
        <title>Migrate query to Supabase</title>
        <subtasks>
          <subtask>Create Supabase client: `const supabase = await createClient()`</subtask>
          <subtask>Replace Prisma query with Supabase query using `.from('orders').select('*').order('created_at', { ascending: false }).limit(100)`</subtask>
        </subtasks>
      </task>
      <task id="3" ac="4.3">
        <title>Add error handling</title>
        <subtasks>
          <subtask>Check for `error` in Supabase response</subtask>
          <subtask>Log error to console: `console.error('Failed to fetch orders:', error.message)`</subtask>
          <subtask>Default to empty array: `const orderList = orders ?? []`</subtask>
        </subtasks>
      </task>
      <task id="4" ac="4.4,4.5,4.6">
        <title>Preserve existing behavior</title>
        <subtasks>
          <subtask>Verify `revalidate = 60` ISR caching setting preserved</subtask>
          <subtask>Verify TransactionsTable receives data correctly</subtask>
          <subtask>Verify admin auth still works (middleware handles)</subtask>
        </subtasks>
      </task>
      <task id="5" ac="4.4">
        <title>Verify TransactionsTable component</title>
        <subtasks>
          <subtask>Check if TransactionsTable uses Prisma Decimal type</subtask>
          <subtask>Change `total` from `any` (Prisma Decimal) to `number`</subtask>
          <subtask>Remove any `@prisma/client` imports</subtask>
        </subtasks>
      </task>
      <task id="6" ac="4.4,4.5">
        <title>Manual verification</title>
        <subtasks>
          <subtask>Run `npm run dev`</subtask>
          <subtask>Login at `/admin/login`</subtask>
          <subtask>Navigate to `/admin/dashboard` - verify transactions display</subtask>
          <subtask>Verify unauthenticated access redirects to login</subtask>
        </subtasks>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-4.1">src/app/admin/dashboard/page.tsx imports `createClient` from `@/lib/supabase/server`</criterion>
    <criterion id="AC-4.2">Dashboard uses Supabase query: `supabase.from('orders').select('*').order('created_at', { ascending: false })`</criterion>
    <criterion id="AC-4.3">Error handling implemented for failed queries</criterion>
    <criterion id="AC-4.4">TransactionsTable receives data correctly</criterion>
    <criterion id="AC-4.5">Admin authentication still works (middleware unchanged)</criterion>
    <criterion id="AC-4.6">`revalidate = 60` ISR caching setting preserved</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Epic 1 Technical Specification</title>
        <section>AC-4: Admin Dashboard Migration (Story 1.4)</section>
        <snippet>Detailed migration plan from Prisma to Supabase for admin dashboard. Query pattern: `supabase.from('orders').select('*').order('created_at', { ascending: false }).limit(100)`</snippet>
      </doc>
      <doc>
        <path>docs/planning/epics/epic-1-database-migration-prisma-supabase.md</path>
        <title>Epic 1: Database Migration</title>
        <section>Story 1.4: Migrate Admin Dashboard to Supabase</section>
        <snippet>As admin, view transactions from Supabase. Replace Prisma query with Supabase client. Handle errors, preserve TransactionsTable, auth middleware, and ISR caching.</snippet>
      </doc>
      <doc>
        <path>docs/planning/architecture/data-architecture.md</path>
        <title>Data Architecture</title>
        <section>Database Schema and RLS Policies</section>
        <snippet>Orders table schema with RLS policy "Admins can view all orders" using auth.uid() check. Fields: id, order_number, customer_phone, total_amount, payment_method, payment_status, order_status, created_at.</snippet>
      </doc>
      <doc>
        <path>docs/planning/architecture/implementation-patterns.md</path>
        <title>Implementation Patterns</title>
        <section>Database Query Pattern (Supabase-Only)</section>
        <snippet>CRITICAL: Use createClient from @/lib/supabase/server for server-side queries. Pattern: `const supabase = await createClient(); const { data, error } = await supabase.from('table').select('*')`</snippet>
      </doc>
      <doc>
        <path>docs/planning/architecture/critical-architecture-decision-supabase-only-data-layer.md</path>
        <title>ADR-001: Supabase-Only Data Layer</title>
        <section>Critical Architecture Decision</section>
        <snippet>Remove Prisma entirely. Supabase client enforces RLS (critical for admin auth), eliminates schema drift, provides better performance via PostgREST.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/1-3-migrate-landing-page-to-supabase.md</path>
        <title>Story 1.3: Migrate Landing Page (DONE)</title>
        <section>Dev Agent Record - Learnings</section>
        <snippet>PATTERN: Use `createClient` from `@/lib/supabase/server`. FeaturedProducts needed Decimalâ†’number type fix. Empty state handling required (return null when empty).</snippet>
      </doc>
    </docs>
    <code>
      <file>
        <path>src/app/admin/dashboard/page.tsx</path>
        <kind>page</kind>
        <symbol>AdminDashboardPage</symbol>
        <lines>1-74</lines>
        <reason>PRIMARY file to modify. Currently imports prisma (line 3), uses prisma.orders.findMany (line 17-20). Must replace with Supabase.</reason>
      </file>
      <file>
        <path>src/lib/supabase/server.ts</path>
        <kind>service</kind>
        <symbol>createClient</symbol>
        <lines>1-29</lines>
        <reason>Supabase server client to import. Uses @supabase/ssr with cookie-based auth. Already exists, no changes needed.</reason>
      </file>
      <file>
        <path>src/components/admin/TransactionsTable.tsx</path>
        <kind>component</kind>
        <symbol>TransactionsTable</symbol>
        <lines>1-247</lines>
        <reason>Receives orders array. Has `total: any // Prisma Decimal` on line 38. Must change to `total: number`. No @prisma/client import found.</reason>
      </file>
      <file>
        <path>src/middleware.ts</path>
        <kind>middleware</kind>
        <symbol>middleware</symbol>
        <lines>1-63</lines>
        <reason>Auth middleware for /admin/* routes. Uses Supabase auth.getSession(). NO changes needed - already uses Supabase.</reason>
      </file>
    </code>
    <dependencies>
      <node>
        <package>@supabase/ssr</package>
        <version>^0.7.0</version>
        <usage>createServerClient for cookie-based auth in server components</usage>
      </node>
      <node>
        <package>@supabase/supabase-js</package>
        <version>^2.84.0</version>
        <usage>Supabase JavaScript client</usage>
      </node>
      <node>
        <package>next</package>
        <version>16.0.3</version>
        <usage>Next.js App Router with Server Components</usage>
      </node>
      <node>
        <package>date-fns</package>
        <version>^4.1.0</version>
        <usage>Used in TransactionsTable for date formatting</usage>
      </node>
      <node>
        <package>react-hot-toast</package>
        <version>^2.6.0</version>
        <usage>Toast notifications in TransactionsTable</usage>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">ADR-001 MANDATE: Never use Prisma - use Supabase client exclusively</constraint>
    <constraint type="pattern">All database queries MUST use `createClient()` from `@/lib/supabase/server` for server components</constraint>
    <constraint type="error-handling">All Supabase queries MUST handle `{ data, error }` response pattern with console.error logging</constraint>
    <constraint type="security">Supabase client automatically enforces RLS policies - admin session required for orders table access</constraint>
    <constraint type="caching">PRESERVE `revalidate = 60` export for ISR caching (line 6 in page.tsx)</constraint>
    <constraint type="middleware">DO NOT modify src/middleware.ts - auth redirect already works with Supabase</constraint>
    <constraint type="component">TransactionsTable uses `total: any` for Prisma Decimal - must change to `total: number`</constraint>
    <constraint type="schema">Supabase `orders` table has `total_amount` column (not `total`) - verify column mapping</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>createClient</name>
      <kind>function</kind>
      <signature>async function createClient(): Promise&lt;SupabaseClient&gt;</signature>
      <path>src/lib/supabase/server.ts</path>
    </interface>
    <interface>
      <name>Supabase Orders Query</name>
      <kind>query pattern</kind>
      <signature>supabase.from('orders').select('*').order('created_at', { ascending: false }).limit(100)</signature>
      <path>N/A - pattern to implement</path>
    </interface>
    <interface>
      <name>TransactionsTableProps</name>
      <kind>interface</kind>
      <signature>interface TransactionsTableProps { orders: Order[] }</signature>
      <path>src/components/admin/TransactionsTable.tsx:45-47</path>
    </interface>
    <interface>
      <name>Order Type (Current)</name>
      <kind>type</kind>
      <signature>type Order = { id: string; order_number: string; customer_phone: string; total: any; payment_method: string; payment_status: string; order_status: string; created_at: Date }</signature>
      <path>src/components/admin/TransactionsTable.tsx:34-43</path>
    </interface>
    <interface>
      <name>Order Type (Expected Supabase)</name>
      <kind>type</kind>
      <signature>type Order = { id: string; order_number: string; customer_phone: string; total_amount: number; payment_method: string; payment_status: string; order_status: string; created_at: string }</signature>
      <path>docs/sprint-artifacts/tech-spec-epic-1.md - TypeScript Type Mapping</path>
    </interface>
  </interfaces>

  <tests>
    <standards>No automated tests required per Epic 1 scope (migration-only epic). Manual verification via grep and runtime testing. Code review validates implementation against acceptance criteria. Use `grep -r "prisma" src/` to confirm zero Prisma references after migration.</standards>
    <locations>
      <location>Manual: Browser DevTools Network tab to verify PostgREST requests</location>
      <location>Manual: Supabase Dashboard to verify data queries</location>
      <location>CLI: `grep -r "createClient" src/app/admin/dashboard/` to verify Supabase import</location>
      <location>CLI: `grep -r "prisma" src/app/admin/dashboard/` should return empty</location>
    </locations>
    <ideas>
      <idea ac="AC-4.1">Verify: `grep "createClient" src/app/admin/dashboard/page.tsx` returns match</idea>
      <idea ac="AC-4.1">Verify: `grep "prisma" src/app/admin/dashboard/page.tsx` returns empty</idea>
      <idea ac="AC-4.2">Verify: Query uses `.from('orders').select('*').order('created_at'`</idea>
      <idea ac="AC-4.3">Verify: Code checks `if (error)` and logs with console.error</idea>
      <idea ac="AC-4.4">Verify: TransactionsTable `total` type changed from `any` to `number`</idea>
      <idea ac="AC-4.4">Manual: Run dev, login, check dashboard displays transactions</idea>
      <idea ac="AC-4.5">Manual: Access /admin/dashboard without auth, verify redirect to /admin/login</idea>
      <idea ac="AC-4.6">Verify: `grep "revalidate = 60" src/app/admin/dashboard/page.tsx` returns match</idea>
    </ideas>
  </tests>

  <learnings source="1-3-migrate-landing-page-to-supabase">
    <learning type="critical">Column naming: Supabase uses `is_active` not `active` - verify orders table column names match query</learning>
    <learning type="pattern">Query pattern established: `const supabase = await createClient(); const { data, error } = await supabase.from(...)`</learning>
    <learning type="type-fix">Components with Prisma Decimal imports need fix: change type to `number`, remove `@prisma/client` import</learning>
    <learning type="error-handling">Implement error handling with `{ data, error }` pattern, log with console.error, fallback to empty array</learning>
    <learning type="empty-state">Handle empty state gracefully - return null or show placeholder when data is empty</learning>
    <learning type="verified">Story 1.3 was APPROVED after code review - patterns are validated and safe to reuse</learning>
  </learnings>
</story-context>
